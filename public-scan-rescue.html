<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rescue Equipment Inspection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="scanner.css">
    <style>
        /* ========== EXACT STYLES (unchanged) ========== */
        body {
            background-image: url('images/rescue.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .popup-header h1 { flex-grow: 1; }
        .header-buttons { display: flex; gap: 10px; }
        .back-btn {
            background-color: #6c757d; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; display: flex; align-items: center;
            gap: 5px; font-size: 14px; display: none;
        }
        .back-btn:hover { background-color: #5a6268; }
        .close-btn {
            background-color: #dc3545; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; display: flex; align-items: center;
            gap: 5px; font-size: 14px;
        }
        .close-btn:hover { background-color: #c82333; }

        .equipment-table {
            width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white;
            border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .equipment-table th {
            background-color: #2c3e50; color: white; padding: 12px; text-align: left; font-weight: 600;
        }
        .equipment-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .equipment-table tr:hover { background-color: #f8f9fa; }
        .equipment-table input[type="number"] {
            width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: center;
        }
        .equipment-table textarea {
            width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;
            resize: vertical; min-height: 60px;
        }
        .status-checkbox { width: 24px; height: 24px; cursor: pointer; }

        .bag-info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
            background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-item { display: flex; flex-direction: column; gap: 5px; }
        .info-label { font-weight: bold; color: #2c3e50; font-size: 14px; }
        .info-value {
            font-size: 16px; color: #34495e; padding: 8px; background-color: #f8f9fa;
            border-radius: 4px; border: 1px solid #e9ecef;
        }
        .full-width { grid-column: 1 / -1; }

        .inspection-section { margin-top: 20px; text-align: center; }
        .inspection-btn {
            background-color: #dc3545; color: white; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s;
        }
        .inspection-btn:hover { background-color: #c82333; }
        .inspection-btn.green { background-color: #28a745; }
        .inspection-btn.green:hover { background-color: #218838; }

        .save-section { margin-top: 20px; text-align: center; }
        .save-btn {
            background-color: #28a745; color: white; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s;
        }
        .save-btn:hover { background-color: #218838; }
        .save-success {
            background-color: #d4edda; color: #155724; padding: 12px; border-radius: 5px;
            margin-top: 15px; text-align: center; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* ---------- INSPECTION DETAILS MODAL (RESCUE) ---------- */
        .inspection-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }
        .inspection-modal-content {
            background: white;
            width: 90%;
            max-width: 550px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .inspection-modal-header {
            background: #2c3e50;
            color: white;
            padding: 18px 20px;
            border-radius: 12px 12px 0 0;
        }
        .inspection-modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .inspection-modal-header p {
            margin: 8px 0 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }
        .info-header-container {
            padding: 20px 20px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-value {
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 4px;
            color: #2c3e50;
            background: transparent;
            padding: 0;
            border: none;
        }
        .form-group {
            padding: 0 20px 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        .modal-input, .modal-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.2s;
            box-sizing: border-box;
            background: white;
        }
        .modal-input:focus, .modal-select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-btn-primary {
            background: #28a745;
            color: white;
        }
        .modal-btn-primary:hover {
            background: #218838;
        }
        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }
        .modal-btn-secondary:hover {
            background: #5a6268;
        }
        .required-star {
            color: #dc3545;
        }
    </style>
</head>
<body>

    <!-- ========== INSPECTION DETAILS MODAL (RESCUE) ========== -->
    <div id="inspectionDetailsModalRescue" class="inspection-modal-overlay" style="display: none;">
        <div class="inspection-modal-content">
            <div class="inspection-modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Inspection Details</h2>
                <p>Please fill in all required fields before starting inspection</p>
            </div>
            
            <div class="info-header-container">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">DAY</div>
                        <div class="info-value" id="modalRescueDay">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">DATE</div>
                        <div class="info-value" id="modalRescueDate">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">CURRENT TIME</div>
                        <div class="info-value" id="modalRescueTime">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">STATION</div>
                        <div class="info-value" id="modalRescueStation">-</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Inspector Name <span class="required-star">*</span></label>
                <input type="text" id="modalRescueInspector" class="modal-input" autocomplete="off">
            </div>

            <div class="form-group">
                <label>Shift <span class="required-star">*</span></label>
                <select id="modalRescueShift" class="modal-select">
                    <option value="" disabled selected>-- Select Shift --</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                    <option value="D">Shift D</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="cancelInspectionDetails()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveInspectionDetailsRescue()">Continue to Inspect</button>
            </div>
        </div>
    </div>

    <!-- Main popup content -->
    <div class="info-popup">
        <div class="popup-header">
            <h1><i class="fas fa-life-ring"></i> Rescue Equipment Inspection</h1>
            <div class="header-buttons">
                <button class="close-btn" onclick="closePopup()"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="loading-container" id="loadingMessage">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading rescue equipment information...</p>
        </div>

        <div class="error-container" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <p id="errorText"></p>
            <button class="action-btn" onclick="retryLoading()"><i class="fas fa-redo"></i> Try Again</button>
        </div>

        <div id="rescueInfoContent" style="display: none;">
            <div class="bag-info-grid" id="bagInfo">
                <div class="info-item">
                    <div class="info-label">Category</div>
                    <div class="info-value" id="category">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Location</div>
                    <div class="info-value" id="location">-</div>
                </div>
                <div class="info-item full-width" id="bagIdRow">
                    <div class="info-label">Bag ID</div>
                    <div class="info-value" id="bagId">-</div>
                </div>
            </div>

            <div class="equipment-section">
                <h3><i class="fas fa-tools"></i> <span id="categoryTitle">Equipment</span></h3>
                <table class="equipment-table" id="equipmentTable">
                    <thead>
                        <tr>
                            <th>Equipment Name</th>
                            <th>Min Qty</th>
                            <th>Current Qty</th>
                            <th>Remarks</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentList"></tbody>
                </table>
            </div>

            <div class="inspection-section">
                <button class="inspection-btn red" id="inspectionBtn" onclick="toggleInspectionMode()">
                    <i class="fas fa-clipboard-check"></i> Inspection
                </button>
            </div>
            <div class="save-section" id="saveSection" style="display: none;">
                <button class="save-btn" onclick="saveAllData()"><i class="fas fa-save"></i> SAVE ALL CHANGES</button>
            </div>
            <div id="saveSuccessMessage" class="save-success" style="display: none;">
                <i class="fas fa-check-circle"></i> Save Success!
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBf9xdF0qmVYaNWFUuEys-P5a1yuTpLdVY",
            authDomain: "project123-82272.firebaseapp.com",
            projectId: "project123-82272",
            storageBucket: "project123-82272.firebasestorage.app",
            messagingSenderId: "97561643123",
            appId: "1:97561643123:web:92596bb20645124f68c206",
            measurementId: "G-D5P85TT95P"
        };

        // ==================== CATEGORY MAP ====================
        const CATEGORY_MAP = {
            'RO': 'Rope Bag',
            'TO': 'Top Bag',
            'BO': 'Bottom Bag',
            'AU': 'Auxiliary',
            'PP': 'PPE'
        };

        // ==================== STATION MAP (QR ‚Üí new name) ====================
        const STATION_MAP = {
            'MA': 'Main Station',
            'ST': 'ST_AMBIGUOUS',   // üü¢ AMBIGUOUS ‚Äì both Station A and Station B use 'ST'
            'SA': 'Station A',       // new code for Station A
            'SB': 'Station B'        // new code for Station B
        };

        // ==================== OLD NAMES (Firestore) ====================
        const STATION_OLD_MAP = {
            'Station A': 'ST A',
            'Station B': 'ST B'
        };

        // ==================== CANONICAL NAMES ====================
        const STATION_CANONICAL = {
            'Main Station': 'Main Station',
            'Station A': 'Station A',
            'Station B': 'Station B',
            'ST A': 'Station A',
            'ST B': 'Station B'
        };

        // ==================== ALL POSSIBLE STATION NAMES FOR QUERY ====================
        const ALL_STATION_VARIANTS = {
            'Main Station': ['Main Station'],
            'Station A': ['Station A', 'ST A'],
            'Station B': ['Station B', 'ST B']
        };

        // ==================== EQUIPMENT DATABASE (DEFAULT) - TIDAK DIGUNAKAN LAGI UNTUK MASTER ====================
        const EQUIPMENT_DATABASE = {
            "Rope Bag": [
                "Main Line 100m (11‚Äì13mm)",
                "Belay/Safety Line 100m (11‚Äì13mm)",
                "Tag Line 100m/200m (9‚Äì13mm)"
            ],
            "Top Bag": [
                "Carabiner",
                "Figure Of Eight",
                "Webbing",
                "Single Pulley",
                "Double Pulley",
                "Anchor Strap",
                "Sling",
                "Prusik",
                "Rope Pad",
                "Pickoff Strap"
            ],
            "Bottom Bag": [
                "Carabiner",
                "Figure Of Eight",
                "Webbing",
                "Single Pulley",
                "Double Pulley",
                "Anchor Strap",
                "Sling",
                "Prusik",
                "Rope Pad",
                "Webbing",
                "Petzl ID"
            ],
            "Auxiliary": [
                "Main Line 200m (11‚Äì13mm)",
                "Tripod Stand (c/w MA system)",
                "Stretcher"
            ],
            "PPE": [
                "Rescue Harness",
                "Rescue Helmet",
                "Rescue Gloves"
            ]
        };

        let db;
        let currentStation = null;
        let currentCategory = null;
        let equipmentData = [];
        let isEditMode = false;

        // ---------- INSPECTION DETAILS STATE ----------
        let inspectionDetailsRescue = {
            inspectorName: '',
            shift: '',
            submitted: false
        };

        // ---------- FLAG FOR AMBIGUOUS STATION ----------
        let isAmbiguousStation = false;

        // ==================== HELPER: TODAY'S DATE ====================
        function getTodayDate() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            loadRescueDataFromURL();
        });

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("‚úÖ Firebase initialized");
            } catch (error) {
                showError('Failed to initialize database.');
            }
        }

        // ==================== PARSE QR ====================
        function parseQRIdentifier(identifier) {
            let station = null;
            let category = null;
            let rawStationCode = null;
            isAmbiguousStation = false;

            try {
                const qrData = JSON.parse(identifier);
                rawStationCode = qrData.s;
                if (rawStationCode) {
                    if (rawStationCode === 'ST') {
                        isAmbiguousStation = true;
                        station = null;
                        console.log("üîç Ambiguous station code 'ST' detected ‚Äì will resolve by checking data");
                    } else {
                        station = STATION_MAP[rawStationCode] || rawStationCode;
                    }
                }
                if (qrData.c) {
                    category = CATEGORY_MAP[qrData.c] || null;
                }
                console.log("üîç QR parsed:", { raw: rawStationCode, station, category, ambiguous: isAmbiguousStation });
            } catch (e) {
                console.log("Identifier bukan JSON, guna parsing manual");
                let str = identifier.replace(/^Rope Bag\s*/i, '').trim();
                if (str.toUpperCase().includes('MS') || str.includes('Main Station')) {
                    station = 'Main Station';
                } else if (str.toUpperCase().includes('ST A') || str.includes('Station A')) {
                    station = 'Station A';
                } else if (str.toUpperCase().includes('ST B') || str.includes('Station B')) {
                    station = 'Station B';
                } else if (str.toUpperCase().includes('ST')) {
                    isAmbiguousStation = true;
                    station = null;
                    console.log("üîç Ambiguous 'ST' in text QR ‚Äì will resolve by checking data");
                }
            }
            return { station, category };
        }

        // ==================== LOAD FROM URL ====================
        function loadRescueDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            let identifier = urlParams.get('ropebag');
            if (!identifier) {
                showError('No rope bag identifier provided.');
                return;
            }
            identifier = decodeURIComponent(identifier);
            console.log("üîç Raw identifier:", identifier);

            const parsed = parseQRIdentifier(identifier);
            
            if (!isAmbiguousStation && !parsed.station) {
                showError('Station tidak dikenalpasti dalam QR code.');
                return;
            }
            if (!parsed.category) {
                showError('Category tidak dikenalpasti dalam QR code.');
                return;
            }

            if (!isAmbiguousStation) {
                currentStation = parsed.station;
            } else {
                currentStation = null;
            }
            currentCategory = parsed.category;

            console.log("üìç Station (from QR):", currentStation || "AMBIGUOUS");
            console.log("üì¶ Category:", currentCategory);
            console.log("üö© Ambiguous flag:", isAmbiguousStation);

            showLoading(true);

            document.getElementById('category').textContent = currentCategory;
            document.getElementById('location').textContent = currentStation || "Loading station...";
            document.getElementById('categoryTitle').innerHTML = `<i class="fas fa-tools"></i> Equipment in ${currentCategory}`;

            const bagIdRow = document.getElementById('bagIdRow');
            if (bagIdRow) bagIdRow.style.display = 'none';

            fetchEquipmentForStationAndCategory();
        }

        // ==================== üÜï FIXED: Dapatkan semua dokumen, pisahkan master & harian ====================
        function fetchEquipmentForStationAndCategory() {
            if (!db) { showError('Database not initialized.'); return; }

            const today = getTodayDate();

            // Dapatkan SEMUA dokumen untuk stesen & kategori ini (tanpa filter inspectionDate)
            let allDocsQuery;
            if (isAmbiguousStation) {
                const stationsToQuery = [
                    ...ALL_STATION_VARIANTS['Station A'],
                    ...ALL_STATION_VARIANTS['Station B']
                ];
                allDocsQuery = db.collection('rescueEquipment')
                    .where('station', 'in', stationsToQuery)
                    .where('category', '==', currentCategory);
            } else {
                let stationQueryArray = [currentStation];
                if (STATION_OLD_MAP[currentStation]) {
                    stationQueryArray.push(STATION_OLD_MAP[currentStation]);
                }
                allDocsQuery = db.collection('rescueEquipment')
                    .where('station', 'in', stationQueryArray)
                    .where('category', '==', currentCategory);
            }

            allDocsQuery.get()
                .then(allSnapshot => {
                    // Pisahkan master dan harian
                    const masters = [];
                    const todayDocs = [];

                    allSnapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        // Jika inspectionDate tidak wujud atau null -> master
                        if (!data.hasOwnProperty('inspectionDate') || data.inspectionDate === null) {
                            masters.push(data);
                        } else if (data.inspectionDate === today) {
                            todayDocs.push(data);
                        }
                        // Dokumen dengan inspectionDate selain hari ini (lama) diabaikan
                    });

                    if (masters.length === 0) {
                        // Tiada master ‚Äì papar kosong
                        console.warn("No master equipment found. Showing empty list.");
                        equipmentData = [];
                        afterDataLoad();
                        return;
                    }

                    if (todayDocs.length > 0) {
                        // Ada dokumen harian ‚Äì gunakan terus
                        equipmentData = todayDocs;
                        afterDataLoad();
                    } else {
                        // Tiada dokumen untuk hari ini ‚Äì cipta dari master
                        const batch = db.batch();
                        masters.forEach(master => {
                            const newDocRef = db.collection('rescueEquipment').doc();
                            const newData = {
                                station: master.station,
                                category: master.category,
                                equipment: master.equipment,
                                minimumQuantity: master.minimumQuantity,
                                currentQuantity: 0,
                                remarks: '',
                                status: 'Not Checked',
                                inspector: '',
                                shift: '',
                                inspectionDate: today,
                                uniqueKey: master.uniqueKey,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            batch.set(newDocRef, newData);
                        });

                        batch.commit().then(() => {
                            // Ambil semula dokumen yang baru dicipta
                            // Guna semula allDocsQuery? Lebih mudah buat query baru untuk hari ini
                            let todayQuery;
                            if (isAmbiguousStation) {
                                const stationsToQuery = [
                                    ...ALL_STATION_VARIANTS['Station A'],
                                    ...ALL_STATION_VARIANTS['Station B']
                                ];
                                todayQuery = db.collection('rescueEquipment')
                                    .where('station', 'in', stationsToQuery)
                                    .where('category', '==', currentCategory)
                                    .where('inspectionDate', '==', today);
                            } else {
                                let stationQueryArray = [currentStation];
                                if (STATION_OLD_MAP[currentStation]) {
                                    stationQueryArray.push(STATION_OLD_MAP[currentStation]);
                                }
                                todayQuery = db.collection('rescueEquipment')
                                    .where('station', 'in', stationQueryArray)
                                    .where('category', '==', currentCategory)
                                    .where('inspectionDate', '==', today);
                            }
                            return todayQuery.get().then(newSnapshot => {
                                equipmentData = [];
                                newSnapshot.forEach(doc => {
                                    const data = doc.data();
                                    data.id = doc.id;
                                    equipmentData.push(data);
                                });
                                afterDataLoad();
                            });
                        }).catch(error => {
                            console.error("Error creating daily docs:", error);
                            showError("Gagal mencipta rekod harian.");
                        });
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showError(`Error fetching equipment: ${error.message}`);
                    console.error(error);
                });
        }

        // ==================== AFTER DATA LOAD ====================
        function afterDataLoad() {
            showLoading(false);

            // ---------- Resolve ambiguous station if needed ----------
            if (isAmbiguousStation) {
                let stationAHasData = false;
                let stationBHasData = false;

                equipmentData.forEach(item => {
                    const canonical = STATION_CANONICAL[item.station] || item.station;
                    if (canonical === 'Station A') stationAHasData = true;
                    if (canonical === 'Station B') stationBHasData = true;
                });

                if (stationAHasData && !stationBHasData) {
                    currentStation = 'Station A';
                    console.log("üìç Resolved ambiguous station to Station A (only A has data)");
                } else if (stationBHasData && !stationAHasData) {
                    currentStation = 'Station B';
                    console.log("üìç Resolved ambiguous station to Station B (only B has data)");
                } else if (stationAHasData && stationBHasData) {
                    currentStation = 'Station B';
                    console.log("üìç Ambiguous: both stations have data ‚Äì defaulting to Station B");
                } else {
                    currentStation = 'Station A';
                    console.log("üìç No data found ‚Äì defaulting to Station A");
                }

                document.getElementById('location').textContent = currentStation;
                document.getElementById('modalRescueStation').textContent = currentStation;
                isAmbiguousStation = false;
            }

            if (!currentStation) {
                currentStation = 'Main Station';
                document.getElementById('location').textContent = currentStation;
                document.getElementById('modalRescueStation').textContent = currentStation;
            }

            populateEquipmentTable();
            showInspectionDetailsModal();
        }

        // ==================== POPULATE EQUIPMENT TABLE ====================
        function populateEquipmentTable() {
            const tbody = document.getElementById('equipmentList');
            tbody.innerHTML = '';

            equipmentData.forEach((item, index) => {
                let statusText = 'NOT RECORDED';
                if (item.status === 'Checked') statusText = 'OK';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.equipment || '-'}</td>
                    <td class="min-qty">${item.minimumQuantity || '0'}</td>
                    <td>
                        <span class="current-qty-view">${item.currentQuantity || '0'}</span>
                        <input type="number" class="current-qty-edit" value="${item.currentQuantity || '0'}" min="0" style="display: none;" data-index="${index}">
                    </td>
                    <td>
                        <span class="remarks-view">${item.remarks || '-'}</span>
                        <textarea class="remarks-edit" style="display: none;" data-index="${index}" placeholder="Enter remarks...">${item.remarks || ''}</textarea>
                    </td>
                    <td>
                        <span class="status-view">${statusText}</span>
                        <input type="checkbox" class="status-checkbox status-edit" ${item.status === 'Checked' ? 'checked' : ''} style="display: none;" data-index="${index}">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== CREATE DEFAULT EQUIPMENT ‚Äì TIDAK DIPANGGIL LAGI ====================
        function createDefaultEquipment() {
            console.warn("createDefaultEquipment() should not be called anymore.");
            return Promise.resolve();
        }

        // ==================== INSPECTION DETAILS MODAL ====================
        function showInspectionDetailsModal() {
            if (inspectionDetailsRescue.submitted) {
                document.getElementById('rescueInfoContent').style.display = 'block';
                return;
            }

            const now = new Date();
            const day = now.toLocaleDateString('en-US', { weekday: 'long' });
            const date = now.toLocaleDateString('en-US', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            }).toUpperCase();
            const time = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });

            document.getElementById('modalRescueDay').textContent = day;
            document.getElementById('modalRescueDate').textContent = date;
            document.getElementById('modalRescueTime').textContent = time;
            document.getElementById('modalRescueStation').textContent = currentStation || '-';

            document.getElementById('modalRescueInspector').value = '';
            document.getElementById('modalRescueShift').value = '';

            document.getElementById('inspectionDetailsModalRescue').style.display = 'flex';
        }

        function closeInspectionDetailsModal() {
            document.getElementById('inspectionDetailsModalRescue').style.display = 'none';
        }

        function cancelInspectionDetails() {
            closeInspectionDetailsModal();
            closePopup();
        }

        function saveInspectionDetailsRescue() {
            const inspector = document.getElementById('modalRescueInspector').value.trim();
            const shift = document.getElementById('modalRescueShift').value;
            if (!inspector) { alert('Please enter Inspector Name'); return; }
            if (!shift) { alert('Please select Shift'); return; }
            inspectionDetailsRescue = {
                inspectorName: inspector,
                shift: shift,
                submitted: true
            };
            closeInspectionDetailsModal();
            document.getElementById('rescueInfoContent').style.display = 'block';
            console.log(`‚úÖ Inspection details saved.`, inspectionDetailsRescue);
        }

        // ==================== TOGGLE INSPECTION MODE ====================
        function toggleInspectionMode() {
            isEditMode = !isEditMode;
            const inspectionBtn = document.getElementById('inspectionBtn');
            const saveSection = document.getElementById('saveSection');
            const viewElements = document.querySelectorAll('.current-qty-view, .remarks-view, .status-view');
            const editElements = document.querySelectorAll('.current-qty-edit, .remarks-edit, .status-edit');

            if (isEditMode) {
                inspectionBtn.style.display = 'none';
                viewElements.forEach(el => el.style.display = 'none');
                editElements.forEach(el => el.style.display = 'block');
                saveSection.style.display = 'block';
            } else {
                inspectionBtn.style.display = 'block';
                inspectionBtn.classList.remove('green');
                inspectionBtn.classList.add('red');
                inspectionBtn.innerHTML = '<i class="fas fa-clipboard-check"></i> Inspection';
                viewElements.forEach(el => el.style.display = 'block');
                editElements.forEach(el => el.style.display = 'none');
                saveSection.style.display = 'none';
            }
        }

        // ==================== SAVE ALL DATA ====================
        async function saveAllData() {
            if (!db || equipmentData.length === 0) {
                alert('Database not initialized or no equipment data.');
                return;
            }

            const saveBtn = document.querySelector('.save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            try {
                for (let i = 0; i < equipmentData.length; i++) {
                    const item = equipmentData[i];
                    const currentQtyInput = document.querySelector(`.current-qty-edit[data-index="${i}"]`);
                    const remarksInput = document.querySelector(`.remarks-edit[data-index="${i}"]`);
                    const statusInput = document.querySelector(`.status-edit[data-index="${i}"]`);

                    const updatedData = {
                        currentQuantity: parseInt(currentQtyInput.value) || 0,
                        remarks: remarksInput.value || '',
                        status: statusInput.checked ? 'Checked' : 'Not Checked',
                        lastInspection: firebase.firestore.FieldValue.serverTimestamp(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        inspector: inspectionDetailsRescue.inspectorName,
                        shift: inspectionDetailsRescue.shift
                    };

                    await db.collection('rescueEquipment').doc(item.id).update(updatedData);
                    equipmentData[i] = { ...item, ...updatedData };
                }

                console.log('‚úÖ All data saved');
                updateViewModeData();
                showSaveSuccess();
                setTimeout(() => toggleInspectionMode(), 2000);
            } catch (error) {
                console.error(error);
                alert('Save failed: ' + error.message);
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function updateViewModeData() {
            const rows = document.querySelectorAll('#equipmentList tr');
            rows.forEach((row, index) => {
                const item = equipmentData[index];
                if (item) {
                    row.querySelector('.current-qty-view').textContent = item.currentQuantity || '0';
                    row.querySelector('.remarks-view').textContent = item.remarks || '-';
                    const statusText = item.status === 'Checked' ? 'OK' : 'NOT RECORDED';
                    row.querySelector('.status-view').textContent = statusText;
                    row.querySelector('.current-qty-edit').value = item.currentQuantity || '0';
                    row.querySelector('.remarks-edit').value = item.remarks || '';
                    row.querySelector('.status-edit').checked = item.status === 'Checked';
                }
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showSaveSuccess() {
            const successMessage = document.getElementById('saveSuccessMessage');
            successMessage.style.display = 'flex';
            setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('errorMessage').style.display = 'none';
            if (!show) document.getElementById('rescueInfoContent').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        function retryLoading() {
            loadRescueDataFromURL();
        }

        function closePopup() {
            if (isEditMode && confirm('You have unsaved changes. Close without saving?')) return;
            window.location.href = 'public-inspection.html';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closePopup();
        });
    </script>
</body>
</html>
