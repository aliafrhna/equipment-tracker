<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Rescue Equipment Inspection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="scanner.css">
    <style>
        /* ========== YOUR EXACT STYLES (unchanged structure) ========== */
        body {
            background-image: url('images/rescue.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .popup-header h1 { flex-grow: 1; font-size: 1.5rem; }
        .header-buttons { display: flex; gap: 10px; }
        .close-btn {
            background-color: #dc3545; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; display: flex; align-items: center;
            gap: 5px; font-size: 14px;
        }
        .close-btn:hover { background-color: #c82333; }

        /* table base â€“ exactly like fire truck code */
        .equipment-table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px 0;
            border-radius: 8px;
        }

        .equipment-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .equipment-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .equipment-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .equipment-table tr:hover { background-color: #f8f9fa; }
        .equipment-table input[type="number"] {
            width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: center;
        }
        .equipment-table textarea {
            width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;
            resize: vertical; min-height: 60px;
        }
        .status-checkbox { width: 24px; height: 24px; cursor: pointer; }

        .bag-info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
            background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-item { display: flex; flex-direction: column; gap: 5px; }
        .info-label { font-weight: bold; color: #2c3e50; font-size: 14px; }
        .info-value {
            font-size: 16px; color: #34495e; padding: 8px; background-color: #f8f9fa;
            border-radius: 4px; border: 1px solid #e9ecef;
        }
        .full-width { grid-column: 1 / -1; }

        .inspection-section { margin-top: 20px; text-align: center; }
        .inspection-btn {
            background-color: #dc3545; color: white; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s;
        }
        .inspection-btn:hover { background-color: #c82333; }
        .save-section { margin-top: 20px; text-align: center; }
        .save-btn {
            background-color: #28a745; color: white; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s;
        }
        .save-btn:hover { background-color: #218838; }
        .save-success {
            background-color: #d4edda; color: #155724; padding: 12px; border-radius: 5px;
            margin-top: 15px; text-align: center; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* ---------- INSPECTION DETAILS MODAL (unchanged) ---------- */
        .inspection-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }
        .inspection-modal-content {
            background: white;
            width: 90%;
            max-width: 550px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .inspection-modal-header {
            background: #2c3e50;
            color: white;
            padding: 18px 20px;
            border-radius: 12px 12px 0 0;
        }
        .inspection-modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-header-container { padding: 20px 20px 0; }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-value {
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 4px;
            color: #2c3e50;
            background: transparent;
            padding: 0;
            border: none;
        }
        .form-group { padding: 0 20px 20px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        .modal-input, .modal-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.2s;
            box-sizing: border-box;
            background: white;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-btn-primary { background: #28a745; color: white; }
        .modal-btn-primary:hover { background: #218838; }
        .modal-btn-secondary { background: #6c757d; color: white; }
        .modal-btn-secondary:hover { background: #5a6268; }
        .required-star { color: #dc3545; }

        /* ========== ðŸ“± MOBILE COMPACT â€“ exactly like fire truck ========== */
        @media screen and (max-width: 768px) {
            .info-popup { padding: 10px; }
            .popup-header h1 { font-size: 1.3rem; }
            .bag-info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
            /* table becomes horizontally scrollable */
            .equipment-table {
                min-width: 650px;  /* forces scroll on small screens */
                font-size: 0.85rem;
            }
            .equipment-table th,
            .equipment-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            .equipment-table input[type="number"] {
                width: 60px;
                padding: 4px;
            }
            .equipment-table textarea {
                min-height: 40px;
                font-size: 0.8rem;
                width: 120px;
            }
            .status-checkbox {
                width: 20px;
                height: 20px;
            }
            .inspection-btn, .save-btn {
                width: 100%;
                padding: 14px 10px;
                font-size: 1rem;
                justify-content: center;
            }
            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .modal-footer {
                flex-direction: column;
                gap: 8px;
            }
            .modal-btn { width: 100%; }
            .inspection-modal-content { width: 95%; margin: 10px; }
        }

        /* extra small */
        @media screen and (max-width: 480px) {
            .equipment-table th,
            .equipment-table td {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>

    <!-- INSPECTION DETAILS MODAL (same) -->
    <div id="inspectionDetailsModalRescue" class="inspection-modal-overlay" style="display: none;">
        <div class="inspection-modal-content">
            <div class="inspection-modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Inspection Details</h2>
                <p>Fill required fields before starting</p>
            </div>
            <div class="info-header-container">
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">DAY</div><div class="info-value" id="modalRescueDay">-</div></div>
                    <div class="info-item"><div class="info-label">DATE</div><div class="info-value" id="modalRescueDate">-</div></div>
                    <div class="info-item"><div class="info-label">CURRENT TIME</div><div class="info-value" id="modalRescueTime">-</div></div>
                    <div class="info-item"><div class="info-label">STATION</div><div class="info-value" id="modalRescueStation">-</div></div>
                </div>
            </div>
            <div class="form-group">
                <label>Inspector Name <span class="required-star">*</span></label>
                <input type="text" id="modalRescueInspector" class="modal-input">
            </div>
            <div class="form-group">
                <label>Shift <span class="required-star">*</span></label>
                <select id="modalRescueShift" class="modal-select">
                    <option value="" disabled selected>-- Select Shift --</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                    <option value="D">Shift D</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="cancelInspectionDetails()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveInspectionDetailsRescue()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Main popup -->
    <div class="info-popup">
        <div class="popup-header">
            <h1><i class="fas fa-life-ring"></i> Rescue Equipment</h1>
            <div class="header-buttons">
                <button class="close-btn" onclick="closePopup()"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="loading-container" id="loadingMessage">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading equipment...</p>
        </div>

        <div class="error-container" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <p id="errorText"></p>
            <button class="action-btn" onclick="retryLoading()"><i class="fas fa-redo"></i> Try Again</button>
        </div>

        <div id="rescueInfoContent" style="display: none;">
            <div class="bag-info-grid">
                <div class="info-item"><div class="info-label">Category</div><div class="info-value" id="category">-</div></div>
                <div class="info-item"><div class="info-label">Location</div><div class="info-value" id="location">-</div></div>
            </div>

            <div class="equipment-section">
                <h3><i class="fas fa-tools"></i> <span id="categoryTitle">Equipment</span></h3>
                <div class="equipment-table-container">
                    <table class="equipment-table" id="equipmentTable">
                        <thead>
                            <tr><th>Equipment</th><th>Min</th><th>Current</th><th>Remarks</th><th>Status</th></tr>
                        </thead>
                        <tbody id="equipmentList"></tbody>
                    </table>
                </div>
            </div>

            <div class="inspection-section">
                <button class="inspection-btn red" id="inspectionBtn" onclick="toggleInspectionMode()">
                    <i class="fas fa-clipboard-check"></i> Inspection
                </button>
            </div>
            <div class="save-section" id="saveSection" style="display: none;">
                <button class="save-btn" onclick="saveAllData()"><i class="fas fa-save"></i> SAVE ALL</button>
            </div>
            <div id="saveSuccessMessage" class="save-success" style="display: none;">
                <i class="fas fa-check-circle"></i> Save Success!
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBf9xdF0qmVYaNWFUuEys-P5a1yuTpLdVY",
            authDomain: "project123-82272.firebaseapp.com",
            projectId: "project123-82272",
            storageBucket: "project123-82272.firebasestorage.app",
            messagingSenderId: "97561643123",
            appId: "1:97561643123:web:92596bb20645124f68c206"
        };

        // Maps (same as before)
        const CATEGORY_MAP = { 'RO':'Rope Bag','TO':'Top Bag','BO':'Bottom Bag','AU':'Auxiliary','PP':'PPE' };
        const STATION_MAP = { 'MA':'Main Station','ST':'ST_AMBIGUOUS','SA':'Station A','SB':'Station B' };
        const STATION_OLD_MAP = { 'Station A':'ST A','Station B':'ST B' };
        const STATION_CANONICAL = { 'Main Station':'Main Station','Station A':'Station A','Station B':'Station B','ST A':'Station A','ST B':'Station B' };
        const ALL_STATION_VARIANTS = { 'Main Station':['Main Station'],'Station A':['Station A','ST A'],'Station B':['Station B','ST B'] };
        const EQUIPMENT_DATABASE = {
            "Rope Bag": ["Main Line 100m (11â€“13mm)","Belay/Safety Line 100m (11â€“13mm)","Tag Line 100m/200m (9â€“13mm)"],
            "Top Bag": ["Carabiner","Figure Of Eight","Webbing","Single Pulley","Double Pulley","Anchor Strap","Sling","Prusik","Rope Pad","Pickoff Strap"],
            "Bottom Bag": ["Carabiner","Figure Of Eight","Webbing","Single Pulley","Double Pulley","Anchor Strap","Sling","Prusik","Rope Pad","Webbing","Petzl ID"],
            "Auxiliary": ["Main Line 200m (11â€“13mm)","Tripod Stand (c/w MA system)","Stretcher"],
            "PPE": ["Rescue Harness","Rescue Helmet","Rescue Gloves"]
        };

        let db, currentStation, currentCategory, equipmentData = [], isEditMode = false;
        let inspectionDetailsRescue = { inspectorName: '', shift: '', submitted: false };
        let isAmbiguousStation = false;

        function sanitizeDocId(str) { return str.replace(/[^a-zA-Z0-9_-]/g, '_'); }

        document.addEventListener('DOMContentLoaded', () => { initializeFirebase(); loadRescueDataFromURL(); });

        function initializeFirebase() {
            try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); db = firebase.firestore(); console.log("âœ… Firebase"); } 
            catch (e) { showError('Failed to init DB.'); }
        }

        function parseQRIdentifier(identifier) {
            let station = null, category = null, rawStationCode = null; isAmbiguousStation = false;
            try {
                const qrData = JSON.parse(identifier);
                rawStationCode = qrData.s;
                if (rawStationCode) {
                    if (rawStationCode === 'ST') { isAmbiguousStation = true; station = null; } 
                    else station = STATION_MAP[rawStationCode] || rawStationCode;
                }
                if (qrData.c) category = CATEGORY_MAP[qrData.c] || null;
            } catch (e) {
                let str = identifier.replace(/^Rope Bag\s*/i,'').trim();
                if (str.toUpperCase().includes('MS') || str.includes('Main Station')) station = 'Main Station';
                else if (str.toUpperCase().includes('ST A') || str.includes('Station A')) station = 'Station A';
                else if (str.toUpperCase().includes('ST B') || str.includes('Station B')) station = 'Station B';
                else if (str.toUpperCase().includes('ST')) { isAmbiguousStation = true; station = null; }
            }
            return { station, category };
        }

        function loadRescueDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            let identifier = urlParams.get('ropebag');
            if (!identifier) { showError('No rope bag identifier.'); return; }
            identifier = decodeURIComponent(identifier);
            const parsed = parseQRIdentifier(identifier);
            if (!isAmbiguousStation && !parsed.station) { showError('Station not recognised.'); return; }
            if (!parsed.category) { showError('Category not recognised.'); return; }
            if (!isAmbiguousStation) currentStation = parsed.station; else currentStation = null;
            currentCategory = parsed.category;
            showLoading(true);
            document.getElementById('category').textContent = currentCategory;
            document.getElementById('location').textContent = currentStation || "Loading...";
            document.getElementById('categoryTitle').innerHTML = `<i class="fas fa-tools"></i> ${currentCategory}`;
            fetchEquipmentForStationAndCategory();
        }

        // ========== FETCH WITH DEDUPLICATION ==========
        function fetchEquipmentForStationAndCategory() {
            if (!db) { showError('DB not ready.'); return; }
            let query;
            if (isAmbiguousStation) {
                const stationsToQuery = [...ALL_STATION_VARIANTS['Station A'], ...ALL_STATION_VARIANTS['Station B']];
                query = db.collection('rescueEquipment').where('station', 'in', stationsToQuery).where('category', '==', currentCategory);
            } else {
                let stationQueryArray = [currentStation];
                if (STATION_OLD_MAP[currentStation]) stationQueryArray.push(STATION_OLD_MAP[currentStation]);
                query = db.collection('rescueEquipment').where('station', 'in', stationQueryArray).where('category', '==', currentCategory);
            }

            query.get().then(snapshot => {
                showLoading(false);
                // Filter out daily records (if any have inspectionDate)
                const masterDocs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.hasOwnProperty('inspectionDate') && data.inspectionDate) return;
                    masterDocs.push({ id: doc.id, ...data });
                });

                // Deduplicate by station|category|equipment (keep latest)
                const uniqueMap = new Map();
                masterDocs.forEach(item => {
                    const key = `${item.station}|${item.category}|${item.equipment}`;
                    const existing = uniqueMap.get(key);
                    if (!existing) uniqueMap.set(key, item);
                    else {
                        const existingTime = existing.timestamp?.seconds || 0;
                        const newTime = item.timestamp?.seconds || 0;
                        if (newTime > existingTime) uniqueMap.set(key, item);
                    }
                });
                const uniqueEquipment = Array.from(uniqueMap.values());

                // Resolve ambiguous station if needed
                if (isAmbiguousStation) {
                    let hasA = false, hasB = false;
                    uniqueEquipment.forEach(item => {
                        const can = STATION_CANONICAL[item.station] || item.station;
                        if (can === 'Station A') hasA = true;
                        if (can === 'Station B') hasB = true;
                    });
                    if (hasA && !hasB) currentStation = 'Station A';
                    else if (hasB && !hasA) currentStation = 'Station B';
                    else if (hasA && hasB) currentStation = 'Station B';
                    else currentStation = 'Station A';
                    document.getElementById('location').textContent = currentStation;
                    document.getElementById('modalRescueStation').textContent = currentStation;
                    isAmbiguousStation = false;
                }

                if (uniqueEquipment.length === 0) { createDefaultEquipment(); return; }

                // Filter by current station
                equipmentData = uniqueEquipment.filter(item => {
                    const can = STATION_CANONICAL[item.station] || item.station;
                    return can === currentStation;
                });
                if (equipmentData.length === 0) { createDefaultEquipment(); return; }

                populateEquipmentTable();
                showInspectionDetailsModal();
            }).catch(err => { showLoading(false); showError(err.message); });
        }

        function populateEquipmentTable() {
            const tbody = document.getElementById('equipmentList');
            tbody.innerHTML = '';
            equipmentData.forEach((item, idx) => {
                let statusText = item.status === 'Checked' ? 'OK' : 'NOT RECORDED';
                tbody.innerHTML += `<tr>
                    <td>${item.equipment || '-'}</td>
                    <td>${item.minimumQuantity || '0'}</td>
                    <td><span class="current-qty-view">${item.currentQuantity || '0'}</span><input type="number" class="current-qty-edit" value="${item.currentQuantity || '0'}" min="0" style="display:none;" data-index="${idx}"></td>
                    <td><span class="remarks-view">${item.remarks || '-'}</span><textarea class="remarks-edit" style="display:none;" data-index="${idx}">${item.remarks || ''}</textarea></td>
                    <td><span class="status-view">${statusText}</span><input type="checkbox" class="status-checkbox status-edit" ${item.status === 'Checked' ? 'checked' : ''} style="display:none;" data-index="${idx}"></td>
                </tr>`;
            });
        }

        // ========== CREATE DEFAULT WITH DETERMINISTIC ID ==========
        function createDefaultEquipment() {
            const defaultList = EQUIPMENT_DATABASE[currentCategory];
            if (!defaultList || defaultList.length === 0) {
                equipmentData = [];
                populateEquipmentTable();
                showInspectionDetailsModal();
                return;
            }
            const batch = db.batch();
            defaultList.forEach(equipName => {
                const masterId = sanitizeDocId(`${currentStation}|${currentCategory}|${equipName}`);
                const docRef = db.collection('rescueEquipment').doc(masterId);
                batch.set(docRef, {
                    station: currentStation,
                    category: currentCategory,
                    equipment: equipName,
                    minimumQuantity: 1,
                    currentQuantity: 0,
                    remarks: '',
                    status: 'Not Checked',
                    uniqueKey: masterId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            });
            batch.commit().then(() => {
                console.log('âœ… Default equipment created');
                fetchEquipmentForStationAndCategory();
            }).catch(err => showError(err.message));
        }

        // ========== INSPECTION MODAL ==========
        function showInspectionDetailsModal() {
            if (inspectionDetailsRescue.submitted) { document.getElementById('rescueInfoContent').style.display = 'block'; return; }
            const now = new Date();
            document.getElementById('modalRescueDay').textContent = now.toLocaleDateString('en-US',{weekday:'long'});
            document.getElementById('modalRescueDate').textContent = now.toLocaleDateString('en-US',{day:'numeric',month:'short',year:'numeric'}).toUpperCase();
            document.getElementById('modalRescueTime').textContent = now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
            document.getElementById('modalRescueStation').textContent = currentStation || '-';
            document.getElementById('modalRescueInspector').value = '';
            document.getElementById('modalRescueShift').value = '';
            document.getElementById('inspectionDetailsModalRescue').style.display = 'flex';
        }

        function saveInspectionDetailsRescue() {
            const inspector = document.getElementById('modalRescueInspector').value.trim();
            const shift = document.getElementById('modalRescueShift').value;
            if (!inspector || !shift) { alert('Please fill all fields'); return; }
            inspectionDetailsRescue = { inspectorName: inspector, shift, submitted: true };
            document.getElementById('inspectionDetailsModalRescue').style.display = 'none';
            document.getElementById('rescueInfoContent').style.display = 'block';
        }

        function cancelInspectionDetails() { closeInspectionDetailsModal(); closePopup(); }
        function closeInspectionDetailsModal() { document.getElementById('inspectionDetailsModalRescue').style.display = 'none'; }

        // ========== EDIT MODE TOGGLE ==========
        function toggleInspectionMode() {
            isEditMode = !isEditMode;
            const inspectionBtn = document.getElementById('inspectionBtn');
            const saveSection = document.getElementById('saveSection');
            const views = document.querySelectorAll('.current-qty-view, .remarks-view, .status-view');
            const edits = document.querySelectorAll('.current-qty-edit, .remarks-edit, .status-edit');
            if (isEditMode) {
                inspectionBtn.style.display = 'none';
                views.forEach(el => el.style.display = 'none');
                edits.forEach(el => el.style.display = 'block');
                saveSection.style.display = 'block';
            } else {
                inspectionBtn.style.display = 'block';
                views.forEach(el => el.style.display = 'block');
                edits.forEach(el => el.style.display = 'none');
                saveSection.style.display = 'none';
            }
        }

        // ========== SAVE ALL (update master + inspection log) ==========
        async function saveAllData() {
            if (!db || equipmentData.length === 0) { alert('No data'); return; }
            const saveBtn = document.querySelector('.save-btn');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            try {
                const todayStr = new Date().toISOString().split('T')[0];
                for (let i = 0; i < equipmentData.length; i++) {
                    const item = equipmentData[i];
                    const qty = document.querySelector(`.current-qty-edit[data-index="${i}"]`).value;
                    const rem = document.querySelector(`.remarks-edit[data-index="${i}"]`).value;
                    const chk = document.querySelector(`.status-edit[data-index="${i}"]`).checked;
                    const updated = {
                        currentQuantity: parseInt(qty) || 0,
                        remarks: rem || '',
                        status: chk ? 'Checked' : 'Not Checked',
                        lastInspection: firebase.firestore.FieldValue.serverTimestamp(),
                        inspector: inspectionDetailsRescue.inspectorName,
                        shift: inspectionDetailsRescue.shift
                    };
                    await db.collection('rescueEquipment').doc(item.id).update(updated);
                    equipmentData[i] = { ...item, ...updated };

                    const safeStation = currentStation.replace(/\s+/g,'_');
                    const safeCategory = currentCategory.replace(/\s+/g,'_');
                    const safeEq = item.equipment.replace(/\s+/g,'_');
                    const inspId = `${safeStation}_${safeCategory}_${safeEq}_${todayStr}`;
                    await db.collection('rescueInspections').doc(inspId).set({
                        station: currentStation, category: currentCategory, equipment: item.equipment,
                        currentQuantity: updated.currentQuantity, remarks: updated.remarks, status: updated.status,
                        inspector: inspectionDetailsRescue.inspectorName, shift: inspectionDetailsRescue.shift,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(), date: todayStr
                    });
                }
                updateViewModeData();
                document.getElementById('saveSuccessMessage').style.display = 'flex';
                setTimeout(() => document.getElementById('saveSuccessMessage').style.display = 'none', 2000);
                setTimeout(() => toggleInspectionMode(), 2000);
            } catch (err) { alert('Save failed: '+err.message); } finally {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> SAVE ALL';
                saveBtn.disabled = false;
            }
        }

        function updateViewModeData() {
            const rows = document.querySelectorAll('#equipmentList tr');
            rows.forEach((row, idx) => {
                const item = equipmentData[idx];
                if (item) {
                    row.querySelector('.current-qty-view').textContent = item.currentQuantity;
                    row.querySelector('.remarks-view').textContent = item.remarks || '-';
                    row.querySelector('.status-view').textContent = item.status === 'Checked' ? 'OK' : 'NOT RECORDED';
                    row.querySelector('.current-qty-edit').value = item.currentQuantity;
                    row.querySelector('.remarks-edit').value = item.remarks || '';
                    row.querySelector('.status-edit').checked = item.status === 'Checked';
                }
            });
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('errorMessage').style.display = 'none';
            if (!show) document.getElementById('rescueInfoContent').style.display = 'none';
        }
        function showError(msg) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = msg;
        }
        function retryLoading() { loadRescueDataFromURL(); }
        function closePopup() { window.location.href = 'public-inspection.html'; }
    </script>
</body>
</html>
